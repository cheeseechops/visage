{% extends "base.html" %}

{% block title %}Image {{ image.id }} - People Viewer{% endblock %}

{% block content %}
<style>
  .dark-card {
    background: #181a20;
    border: 1px solid #23263a;
    color: #e5e7eb;
  }
  .dark-card .bg-white, .dark-card .bg-white\/80, .dark-card .bg-gray-50 { background: #23263a !important; }
  .dark-card .text-gray-900, .dark-card .text-gray-700, .dark-card .text-gray-600 { color: #e5e7eb !important; }
  .dark-card .bg-green-100 { background: #234d20 !important; color: #a7f3d0 !important; }
  .dark-card .bg-orange-100 { background: #4b2e05 !important; color: #fdba74 !important; }
  .dark-card .bg-blue-100 { background: #1e293b !important; color: #60a5fa !important; }
  .dark-card .text-blue-800 { color: #60a5fa !important; }
  .dark-card .text-green-800 { color: #6ee7b7 !important; }
  .dark-card .text-orange-800 { color: #fdba74 !important; }
  .dark-card .shadow-sm { box-shadow: 0 2px 8px 0 rgba(0,0,0,0.25); }
  .dark-card .border-gray-200, .dark-card .border-gray-300 { border-color: #23263a !important; }
  .dark-card .border { border-color: #23263a !important; }
  .dark-card .rounded { border-radius: 0.75rem; }
  .dark-card .bg-primary { background: #6366f1 !important; }
  .dark-card .text-primary { color: #6366f1 !important; }
  .dark-card .text-red-500 { color: #f87171 !important; }
  .dark-card .text-gray-400 { color: #9ca3af !important; }
  .dark-card .text-gray-300 { color: #d1d5db !important; }
  .dark-card .text-gray-200 { color: #e5e7eb !important; }
  .dark-card .bg-gray-200 { background: #23263a !important; }
  .dark-card .bg-gray-100 { background: #23263a !important; }
  .dark-card .bg-gray-50 { background: #181a20 !important; }
  .dark-card .bg-black\/60 { background: rgba(20,20,30,0.7) !important; }
  .dark-card .hover\:bg-white:hover { background: #23263a !important; }
  .dark-card .hover\:bg-gray-50:hover { background: #23263a !important; }
  .dark-card .hover\:bg-red-50:hover { background: #3b1e1e !important; }
  .dark-card .hover\:bg-blue-50:hover { background: #1e293b !important; }
  .dark-card .hover\:bg-yellow-50:hover { background: #3b2e1e !important; }
  .dark-card .hover\:bg-primary-dark:hover { background: #3730a3 !important; }
  .dark-card .bg-blue-50 { background: #1e293b !important; }
  .dark-card .bg-yellow-50 { background: #3b2e1e !important; }
  .dark-card .bg-red-50 { background: #3b1e1e !important; }
</style>
<div class="min-h-screen dark-card">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Main Image Display -->
      <div class="lg:col-span-2 flex flex-col items-center justify-center">
        <div class="relative w-full h-full flex items-center justify-center bg-gray-900 rounded-lg shadow-sm border border-gray-700 overflow-hidden min-h-[400px]">
          <img id="main-image" src="{{ image.image_url }}" alt="Image {{ image.id }}" class="w-full h-auto max-h-[80vh] object-contain bg-gray-900 rounded-lg">
          <!-- Fullscreen Button -->
          <button id="fullscreen-btn" title="View Fullscreen" class="absolute top-4 right-4 bg-black/70 hover:bg-black/90 text-white px-3 py-2 rounded shadow-lg z-10 flex items-center">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
            Fullscreen
          </button>
          <!-- Image ID Badge -->
          <div class="absolute top-4 left-4 px-3 py-1 bg-black/60 text-white text-sm rounded-full">#{{ image.id }}</div>
          <!-- Favorite Badge -->
          {% if image.is_favorite %}
          <div class="absolute top-16 left-4 px-3 py-1 bg-red-500 text-white text-sm rounded-full flex items-center">
            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
            Favorite
          </div>
          {% endif %}
        </div>
      </div>
      <!-- Sidebar Info & Actions -->
      <div class="lg:col-span-1 space-y-6">
        <!-- Actions Section -->
        <div class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-6 flex flex-wrap gap-3 justify-between">
          <button onclick="toggleFavorite('image', {{ image.id }})" class="inline-flex items-center px-3 py-2 border border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-200 bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
            <svg class="w-4 h-4 mr-2 {% if image.is_favorite %}text-red-500{% else %}text-gray-400{% endif %}" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>{% if image.is_favorite %}Unfavorite{% else %}Favorite{% endif %}
          </button>
          <button onclick="deleteImage({{ image.id }})" class="inline-flex items-center px-3 py-2 border border-red-600 rounded-md shadow-sm text-sm font-medium text-red-400 bg-gray-900 hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>Delete
          </button>
          <button onclick="rotateImage({{ image.id }}, 'ccw', event)" class="inline-flex items-center px-3 py-2 border border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-200 bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>Rotate Left
          </button>
          <button onclick="rotateImage({{ image.id }}, 'cw', event)" class="inline-flex items-center px-3 py-2 border border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-200 bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>Rotate Right
          </button>
          {% if image.original_path %}
          <button onclick="recropImage({{ image.id }}, event)" class="inline-flex items-center px-3 py-2 border border-blue-600 rounded-md shadow-sm text-sm font-medium text-blue-400 bg-gray-900 hover:bg-blue-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>Recrop
          </button>
          {% endif %}
          {% if 'uncropped' not in image.tags %}
          <button id="setUncroppedBtn" onclick="setAsUncropped({{ image.id }})" class="inline-flex items-center px-3 py-2 border border-yellow-600 rounded-md shadow-sm text-sm font-medium text-yellow-400 bg-gray-900 hover:bg-yellow-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>Set as Uncropped
          </button>
          {% endif %}
          <button onclick="openColorEditor()" class="inline-flex items-center px-3 py-2 border border-purple-600 rounded-md shadow-sm text-sm font-medium text-purple-400 bg-gray-900 hover:bg-purple-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z"></path></svg>Color Editor
          </button>
          <button onclick="startChat({{ image.id }})" class="inline-flex items-center px-3 py-2 border border-green-600 rounded-md shadow-sm text-sm font-medium text-green-400 bg-gray-900 hover:bg-green-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>Chat with me
          </button>
        </div>
        <!-- People Section -->
        <div class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-6">
          <h3 class="text-lg font-medium text-gray-100 mb-4">People in Image</h3>
          {% if people %}
            <div class="space-y-3">
              {% for person in people %}
              <div class="flex items-center justify-between p-3 bg-gray-900 rounded-lg">
                <span class="text-sm font-medium text-gray-100">{{ person.name }}</span>
                <div class="flex items-center space-x-2">
                  <button onclick="renamePerson({{ person.id }}, '{{ person.name }}')" class="text-blue-400 hover:text-blue-200 text-sm">Rename</button>
                  <button onclick="removePersonFromImage({{ image.id }}, {{ person.id }})" class="text-red-400 hover:text-red-200 text-sm">Remove</button>
                  <a href="{{ url_for('person_gallery', person_id=person.id) }}" class="text-primary hover:text-primary-dark text-sm">View Gallery</a>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-4">
              <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
              <p class="mt-2 text-sm text-gray-400">No people identified</p>
              <button onclick="assignPerson({{ image.id }})" class="mt-2 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">Assign Person</button>
            </div>
          {% endif %}
        </div>
        <!-- Tags Section -->
        {% if image.tags %}
        <div class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-6">
          <h3 class="text-lg font-medium text-gray-100 mb-4">Tags</h3>
          <div class="flex flex-wrap gap-2">
            {% for tag in image.tags %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">{{ tag }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        <!-- Metadata Section -->
        <div class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-6">
          <h3 class="text-lg font-medium text-gray-100 mb-4">Image Details</h3>
          <dl class="space-y-3">
            <div class="flex flex-col space-y-1">
              <dt class="text-sm font-medium text-gray-400">Filename</dt>
              <dd class="text-sm text-gray-100 break-words leading-relaxed flex items-center">{{ image.filename }} <button onclick="navigator.clipboard.writeText('{{ image.filename }}')" title="Copy filename" class="ml-2 text-xs text-gray-400 hover:text-primary"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16h8M8 12h8m-6 8h6a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></button></dd>
            </div>
            {% if image.width and image.height %}
            <div class="flex justify-between">
              <dt class="text-sm font-medium text-gray-400">Dimensions</dt>
              <dd class="text-sm text-gray-100">{{ image.width }} Ã— {{ image.height }}</dd>
            </div>
            {% endif %}
            {% if image.created_at %}
            <div class="flex justify-between">
              <dt class="text-sm font-medium text-gray-400">Created</dt>
              <dd class="text-sm text-gray-100">{{ image.created_at[:10] }}</dd>
            </div>
            {% endif %}
            {% if image.original_path %}
            <div class="flex justify-between">
              <dt class="text-sm font-medium text-gray-400">Original</dt>
              <dd class="text-sm text-gray-100"><a href="{{ image.original_path }}" target="_blank" class="text-primary hover:text-primary-dark">View Original</a></dd>
            </div>
            {% endif %}
            {% if image.hash_value %}
            <div class="flex justify-between">
              <dt class="text-sm font-medium text-gray-400">Hash</dt>
              <dd class="text-sm text-gray-100">{{ image.hash_value }}</dd>
            </div>
            {% endif %}
          </dl>
        </div>
        <!-- Recognition Suggestions -->
        {% if image.recognition_suggestions %}
        <div class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-6">
          <h3 class="text-lg font-medium text-gray-100 mb-4">Recognition Suggestions</h3>
          <div class="space-y-2">
            {% for suggestion in image.recognition_suggestions %}
            <div class="flex items-center justify-between p-2 bg-gray-900 rounded">
              <span class="text-sm text-gray-100">{{ suggestion.name }}</span>
              <span class="text-xs text-gray-400">{{ "%.1f"|format(suggestion.confidence * 100) }}%</span>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

<script>
function toggleFavorite(type, id) {
    fetch(`/api/toggle_${type}_favorite/${id}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function deleteImage(imageId) {
    if (!confirm('Are you sure you want to delete this image? This action cannot be undone.')) return;
    fetch(`/api/delete_image/${imageId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.next_image_id) {
                window.location.href = `/image/${data.next_image_id}`;
            } else {
                window.location.href = '/images';
            }
        } else {
            alert('Error deleting image: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error deleting image: ' + error.message);
    });
}

function assignPerson(imageId) {
    const personName = prompt('Enter the name of the person in this image:');
    if (personName && personName.trim()) {
        // First create the person if they don't exist
        fetch('/api/create_person', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: personName.trim()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Then assign the image to the person
                return fetch(`/api/assign_image/${imageId}/${data.person_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
            } else {
                throw new Error(data.error || 'Failed to create person');
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error assigning person: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error assigning person: ' + error.message);
        });
    }
}

function rotateImage(imageId, direction, event) {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Rotating...';
    btn.disabled = true;
    fetch(`/api/rotate_image_by_id/${imageId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ direction })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error rotating image: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error rotating image: ' + error.message);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function recropImage(imageId, event) {
    if (!confirm('This will replace the current image with the original and take you to the cropper. Continue?')) return;
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Recropping...';
    btn.disabled = true;
    fetch(`/api/recrop_image/${imageId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Set as uncropped, then go to cropper
            fetch(`/api/set_uncropped/${imageId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' } })
                .then(() => {
                    window.location.href = `/cropper/${imageId}`;
                });
        } else {
            alert('Error recropping image: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error recropping image: ' + error.message);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function setAsUncropped(imageId) {
    const btn = document.getElementById('setUncroppedBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>Setting...';
    btn.disabled = true;
    fetch(`/api/set_uncropped/${imageId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error setting uncropped');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error setting uncropped');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function openColorEditor() {
    const imageId = {{ image.id }};
    window.location.href = `/color_editor/${imageId}`;
}

function renamePerson(personId, currentName) {
    fetch('/api/people')
        .then(response => response.json())
        .then(data => {
            const people = data.people || [];
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-96 max-w-full mx-4">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Rename Person</h3>
                    <div class="relative">
                        <input type="text" id="rename-input" value="${currentName}" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
                               placeholder="Enter new name" autocomplete="off">
                        <div id="rename-suggestions" class="absolute left-0 right-0 top-full bg-white border border-gray-300 rounded-md mt-1 max-h-40 overflow-y-auto hidden"></div>
                        <div id="rename-error" class="text-red-500 text-xs mt-2 hidden"></div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-4">
                        <button id="rename-cancel-btn" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button id="rename-confirm-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark">Rename</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const input = document.getElementById('rename-input');
            const suggestions = document.getElementById('rename-suggestions');
            const errorDiv = document.getElementById('rename-error');
            const confirmBtn = document.getElementById('rename-confirm-btn');
            const cancelBtn = document.getElementById('rename-cancel-btn');
            let selectedIdx = -1;
            function filterPeople(val) {
                if (!val.trim()) return [];
                const lower = val.toLowerCase();
                return people.filter(p => p.name.toLowerCase().includes(lower) && p.name !== currentName).slice(0, 8);
            }
            function showSuggestions(list) {
                suggestions.innerHTML = '';
                if (!list.length) { suggestions.style.display = 'none'; return; }
                list.forEach((p, idx) => {
                    const item = document.createElement('div');
                    item.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm' + (idx === selectedIdx ? ' bg-gray-200' : '');
                    item.textContent = `${p.name} (${p.image_count} images)`;
                    item.addEventListener('mousedown', e => {
                        input.value = p.name;
                        suggestions.style.display = 'none';
                        selectedIdx = -1;
                    });
                    suggestions.appendChild(item);
                });
                suggestions.style.display = 'block';
            }
            input.addEventListener('input', function() {
                selectedIdx = -1;
                showSuggestions(filterPeople(this.value));
                errorDiv.classList.add('hidden');
            });
            input.addEventListener('keydown', function(e) {
                const items = suggestions.querySelectorAll('div');
                if (e.key === 'ArrowDown') {
                    selectedIdx = Math.min(selectedIdx + 1, items.length - 1);
                    showSuggestions(filterPeople(this.value));
                    if (items[selectedIdx]) items[selectedIdx].scrollIntoView({ block: 'nearest' });
                    e.preventDefault();
                } else if (e.key === 'ArrowUp') {
                    selectedIdx = Math.max(selectedIdx - 1, 0);
                    showSuggestions(filterPeople(this.value));
                    if (items[selectedIdx]) items[selectedIdx].scrollIntoView({ block: 'nearest' });
                    e.preventDefault();
                } else if (e.key === 'Enter' && selectedIdx >= 0 && items[selectedIdx]) {
                    input.value = items[selectedIdx].textContent.split(' (')[0];
                    suggestions.style.display = 'none';
                    selectedIdx = -1;
                    e.preventDefault();
                }
            });
            input.addEventListener('focus', function() {
                showSuggestions(filterPeople(this.value));
            });
            confirmBtn.addEventListener('click', function() {
                const newName = input.value.trim();
                if (!newName) {
                    errorDiv.textContent = 'Name cannot be empty.';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                if (people.some(p => p.name === newName && p.name !== currentName)) {
                    errorDiv.textContent = 'A person with this name already exists.';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                fetch(`/api/update_person/${personId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        errorDiv.textContent = data.error || 'Error updating name.';
                        errorDiv.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    errorDiv.textContent = error.message || 'Error updating name.';
                    errorDiv.classList.remove('hidden');
                });
            });
            cancelBtn.addEventListener('click', function() {
                modal.remove();
            });
            input.focus();
            input.select();
        })
        .catch(error => {
            alert('Error loading people: ' + error.message);
        });
}

function closeRenameModal() {
    const modal = document.querySelector('.fixed.inset-0.z-50');
    if (modal) {
        modal.remove();
    }
}

function confirmRename(personId) {
    const input = document.getElementById('rename-input');
    const newName = input.value.trim();
    if (newName) {
        updatePersonName(personId, newName);
        closeRenameModal();
    }
}

function updatePersonName(personId, newName) {
    fetch(`/api/update_person/${personId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: newName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating person: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating person: ' + error.message);
    });
}

function removePersonFromImage(imageId, personId) {
    if (!confirm('Remove this name tag from the image?')) return;
    fetch(`/api/remove_person_from_image/${imageId}/${personId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error removing name tag: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error removing name tag.');
    });
}

// Fullscreen functionality
console.log('Image detail page loaded');
const fullscreenBtn = document.getElementById('fullscreen-btn');

if (fullscreenBtn) {
  fullscreenBtn.addEventListener('click', function() {
    console.log('Fullscreen button clicked');
    enterFullscreen();
  });
}

function enterFullscreen() {
  const mainImage = document.getElementById('main-image');
  if (!mainImage) {
    console.error('Main image not found');
    return;
  }

  // Create a fullscreen container
  const fullscreenContainer = document.createElement('div');
  fullscreenContainer.id = 'true-fullscreen-container';
  fullscreenContainer.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: black;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  `;

  // Create the image element
  const fullscreenImage = document.createElement('img');
  fullscreenImage.src = mainImage.src;
  fullscreenImage.style.cssText = `
    width: 100%;
    height: 100%;
    object-fit: contain;
  `;
  fullscreenImage.alt = `Image #{{ image.id }}`;

  // Create filename label
  const filenameLabel = document.createElement('div');
  filenameLabel.textContent = `Image #{{ image.id }}`;
  filenameLabel.style.cssText = `
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.75);
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
  `;

  // Create exit button
  const exitButton = document.createElement('button');
  exitButton.innerHTML = `
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
  `;
  exitButton.style.cssText = `
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.75);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: opacity 0.2s;
  `;
  exitButton.onmouseover = () => exitButton.style.opacity = '0.9';
  exitButton.onmouseout = () => exitButton.style.opacity = '1';
  exitButton.onclick = exitFullscreen;

  // Add elements to container
  fullscreenContainer.appendChild(fullscreenImage);
  fullscreenContainer.appendChild(filenameLabel);
  fullscreenContainer.appendChild(exitButton);

  // Add to document
  document.body.appendChild(fullscreenContainer);

  // Request true fullscreen
  if (fullscreenContainer.requestFullscreen) {
    fullscreenContainer.requestFullscreen();
  } else if (fullscreenContainer.webkitRequestFullscreen) {
    fullscreenContainer.webkitRequestFullscreen();
  } else if (fullscreenContainer.msRequestFullscreen) {
    fullscreenContainer.msRequestFullscreen();
  }

  // Listen for fullscreen change
  document.addEventListener('fullscreenchange', handleFullscreenChange);
  document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
  document.addEventListener('msfullscreenchange', handleFullscreenChange);
}

function exitFullscreen() {
  if (document.exitFullscreen) {
    document.exitFullscreen();
  } else if (document.webkitExitFullscreen) {
    document.webkitExitFullscreen();
  } else if (document.msExitFullscreen) {
    document.msExitFullscreen();
  }
}

function handleFullscreenChange() {
  if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
    // Fullscreen was exited, remove the container
    const fullscreenContainer = document.getElementById('true-fullscreen-container');
    if (fullscreenContainer) {
      fullscreenContainer.remove();
    }
    
    // Remove event listeners
    document.removeEventListener('fullscreenchange', handleFullscreenChange);
    document.removeEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.removeEventListener('msfullscreenchange', handleFullscreenChange);
  }
}

function openColorEditor() {
  const imageId = {{ image.id }};
  window.location.href = `/color_editor/${imageId}`;
}

function startChat(imageId) {
  // Show personality input modal
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
      <h3 class="text-lg font-medium text-gray-100 mb-4">Create Chat Session</h3>
      <p class="text-gray-300 mb-4">Describe the personality and chat style for this person:</p>
      <textarea id="personality-input" class="w-full h-32 p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-100 placeholder-gray-400 resize-none" placeholder="e.g., Friendly, outgoing, loves to joke around, speaks casually with lots of emojis..."></textarea>
      <div class="flex justify-end space-x-3 mt-4">
        <button onclick="closeChatModal()" class="px-4 py-2 text-gray-300 hover:text-gray-100">Cancel</button>
        <button onclick="createChatSession(${imageId})" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Create Chat</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function closeChatModal() {
  const modal = document.querySelector('.fixed.inset-0.bg-black');
  if (modal) {
    modal.remove();
  }
}

function createChatSession(imageId) {
  const personalityInput = document.getElementById('personality-input');
  const personality = personalityInput.value.trim();
  
  if (!personality) {
    alert('Please describe the personality for the chat session.');
    return;
  }
  
  // Show loading state
  const createBtn = document.querySelector('button[onclick*="createChatSession"]');
  const originalText = createBtn.textContent;
  createBtn.textContent = 'Creating...';
  createBtn.disabled = true;
  
  // Add progress feedback
  const statusDiv = document.createElement('div');
  statusDiv.className = 'mt-3 text-sm text-gray-400';
  statusDiv.textContent = 'Testing Ollama connection...';
  createBtn.parentNode.appendChild(statusDiv);
  
  // Update status messages
  const updateStatus = (message) => {
    statusDiv.textContent = message;
  };
  
  fetch('/api/chat/create_session', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      image_id: imageId,
      personality_description: personality
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Show system prompt confirmation modal
      showSystemPromptModal(data.session);
    } else {
      updateStatus(`Error: ${data.error}`);
      createBtn.textContent = originalText;
      createBtn.disabled = false;
    }
  })
  .catch(error => {
    console.error('Error:', error);
    updateStatus('Network error. Please try again.');
    createBtn.textContent = originalText;
    createBtn.disabled = false;
  });
}

function showSystemPromptModal(session) {
  // Remove the personality input modal
  closeChatModal();
  
  // Create system prompt confirmation modal
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
      <h3 class="text-lg font-medium text-gray-100 mb-4">Review System Prompt</h3>
      <p class="text-gray-300 mb-4">Review and edit the AI personality before starting the chat:</p>
      
      <div class="flex items-center mb-4">
        <div class="w-16 h-16 rounded-full overflow-hidden mr-4 border-2 border-gray-600">
          <img src="${session.image_url || '/static/uploads/default.jpg'}" alt="Profile" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <div class="w-full h-full bg-gray-700 flex items-center justify-center" style="display: none;">
            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
        </div>
        <div>
          <h4 class="text-sm font-medium text-gray-400 mb-1">Original Personality Description:</h4>
          <p class="text-gray-300 text-sm">${session.personality_description}</p>
        </div>
      </div>
      
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-400 mb-2">Generated System Prompt:</label>
        <textarea id="system-prompt-edit" class="w-full h-64 p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-100 placeholder-gray-400 resize-none text-sm font-mono" placeholder="System prompt will appear here...">${session.system_prompt}</textarea>
        <p class="text-xs text-gray-500 mt-1">You can edit this prompt to refine the AI's personality, tone, or behavior.</p>
      </div>
      
      <div class="flex justify-end space-x-3">
        <button onclick="closeSystemPromptModal()" class="px-4 py-2 text-gray-300 hover:text-gray-100">Cancel</button>
        <button onclick="confirmSystemPrompt(${session.id})" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Start Chat</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function closeSystemPromptModal() {
  const modal = document.querySelector('.fixed.inset-0.bg-black');
  if (modal) {
    modal.remove();
  }
}

function confirmSystemPrompt(sessionId) {
  const systemPromptEdit = document.getElementById('system-prompt-edit');
  const updatedPrompt = systemPromptEdit.value.trim();
  
  if (!updatedPrompt) {
    alert('System prompt cannot be empty.');
    return;
  }
  
  // Update the system prompt
  fetch(`/api/chat/update_system_prompt/${sessionId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      system_prompt: updatedPrompt
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      closeSystemPromptModal();
      // Redirect to the chat session
      window.location.href = `/chat/${sessionId}`;
    } else {
      alert('Error updating system prompt: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error updating system prompt. Please try again.');
  });
}

document.addEventListener('DOMContentLoaded', function() {
  console.log('Image detail page DOM loaded');
});
</script>
{% endblock %} 